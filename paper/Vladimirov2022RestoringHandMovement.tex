\documentclass[a4paper, 12pt]{article}

\input{preamble.tex}
\renewcommand{\abstractname}{Аннотация}

\title{Восстановление траектории движения руки по видео}

\author{Владимиров Эдуард \\
	\texttt{vladimirov.ea@phystech.edu} \\

	\And
	Исаченко Роман \\
	\texttt{roman.isachenko@phystech.edu} \\
	
	\And
	Курдюкова Антонина \\
	\texttt{kurdiukova.ad@phystech.edu} \\
}
\date{\today}

\begin{document}
\maketitle

\begin{abstract}
	В работе решается задача прогнозирования временного ряда со сложной структурой. Под сложной структурой понимается наличие зависимостей и варьирующийся период. Требуется найти причинно-следственные связи между временными рядами. Для этого предлагается снизить размерность траекторных пространств. В работе показано, что методы канонического корреляционного анализа, такие как метод главных компонент, метод частичных наименьших квадратов и другие, являются частным случаем метода перекрестных отображений Сугихары. Для демонстрации результатов работы решается задача восстановления траектория движения руки, восстановленная по видео, и сигнал акселерометра.
\end{abstract}


\keywords{временной ряд \and фазовая траектория \and траекторное подпространство \and сходящееся перекрёстное отображение \and частичные наименьшие квадраты \and канонический корреляционный анализ}

\section{Введение}

В данной работе решается задача прогнозирования временного ряда на основе других рядов. 
Одна из трудностей задачи заключается в обнаружении связи между рядами и исключении несвязанных рядов из прогностической модели. 
Решение этой проблемы повышает качество прогноза.

В данной работе применяется метод сходящегося перекрёстного отображения (convergent cross mapping, CCM) \citep{Sugihara90, sugihara1990nonlinear}, который эффективен для рядов, порождённых динамической системой. 
Он основан на сравнении ближайших соседей в траекторном пространстве ряда $\bx$, полученных с помощью ряда $\by$.

При построении прогностической модели используется траекторная матрица (или матрица сдвига), описывающая фазовое пространство временного ряда. 
Например, в методе анализа спектральных компонент (singular spectrum analysis, SSA) \citep{golyandina2005ssa, golyandina2001analysis, zhigljavsky2010singular} прогноз временного ряда основан на спектральном разложении ковариационной матрицы, полученной по траекторной. 
В CCM матрицы сдвига используются для проверки наличия липшицева отображения между траекторными пространствами.

Однако размерность траекторного пространства может оказаться чрезмерно высокой, что приводит к неустойчивости прогностической модели.
В таком случае необходимо снизить размерность траекторного пространства путём построения проекции фазовой траектории в некоторое подпространство. Для CCM нет конкретного способа выбрать подпространство, в котором аппроксимируется фазовая траектория.
В работе \citep{usmanova2020sphere_regr} эта проблема решается с помощью сферической регрессии. Согласно этому методу, информация об искомом подпространстве извлекается из множества эмпирических направлений $\{ \bx_i - \bx_j\, | \, i < j \}$.
В работе \citep{alexandrov2005automatic} используется автоматический выбор пары главных компонент. Идея заключается в сравнении спектральных плотностей главных компонент. Также используется простой перебор по главным компонентам \citep{usmanova2019dependencies}.

Метод проекции в латентное пространство (partial least squares, PLS) \citep{rosipal2011nonlinear, rosipal2005overview} отбирает наиболее значимые признаки и строит новые как их линейные комбинации. 
Это позволяет получить простую, точную и устойчивую прогностическую модель.
Наряду с PLS используется метод канонического анализа корреляции (CCA) \citep{hardoon2004canonical}. 
Он похож на PLS за исключением того, что первый метод максимизирует ковариацию, а последний ~--- корреляцию. 
Недостатком этих моделей является их низкая точность при оценивании нелинейных зависимостей между данными.
Разработаны нелинейные модели PLS\citep{qin1992nonlinear, hiden1998non} и CCA\citep{lai2000kernel, andrew2013deep}.
В данной статье используется модель NNPLS \citep{bulut2014new}, которая преобразует исходные данные с помощью нейронной сети. 

В теоретической части работы показано, что методы понижения размерности CCA и PLS являются частными случаями CCM. 
Для этой цели вводятся различные меры близости между целевой переменной и её аппроксимацией, являющейся линейной комбинацией её ближайших соседей, для сравнения качества согласованности исходного пространства и его подпространства.

В качестве модели для предсказания временного ряда по набору рядов используется алгоритм локально взвешенного глобального линейного отображения (sequential locally weighted global linear map, SMap) \citep{sugihara1994nonlinear}.

Эксперимент проводится на наборе вручную собранных данных. Он представляет собой совокупность ключевых точек, полученных 
по видео движения человека, а также показания акселерометра и гироскопа, снятые с руки человека. 
В эксперименте строится прогноз рядов, использующий обнаруженные связанные компоненты рядов.

\section{Постановка задачи}
Пусть значения исходного временного ряда $\bx(t)$ доступны в  моменты времени $t = 1, 2, \ldots, n$. Предполагается, что на значения $\bx(t)$ оказывает влияние набор внешних факторов $\by_1(t), \ldots, \by_m(t)$

В момент прогноза $n$ необходимо определить будущие значения исходного ряда $\bx(t)$ в моменты времени $n+1, \ldots, n+p$, учитывая влияние внешних факторов $\by_1(t), \ldots, \by_m(t)$. При этом считаем, что значения внешних факторов являются доступными в моменты времени: \[\by_1(n+1), \ldots, \by_1(n+p), \ldots, \by_m(n+1), \ldots, \by_m(n+p).\]

Для вычисления будущих значений временного ряда требуется определить функциональную зависимость, отражающую связь между прошлыми значениями $\bx$ и будущими, а также принимающую во внимание влияние внешних факторов $\by_1, \ldots, \by_m$:

\begin{equation} \label{eq:general_model}
	\bx(t) = F(\bx(t-1), \ldots, \by_1(t), \, \by_1(t-1), \ldots, \by_m(t), \, \by_m(t-1), ...) + \epsilon_t.
\end{equation}

Зависимость \eqref{eq:general_model} называется \textbf{моделью прогнозирования с учётом внешних факторов}.
Требуется создать такую модель, для которой среднее квадратичное отклонение истинного значения от прогнозируемого стремится к минимальному для заданного $p$. 

\begin{equation} \label{eq:model_error}
	\hat{E} = \dfrac{1}{p} \sum\limits_{i=n+1}^{n+p} \epsilon_i^2 \rightarrow \underset{F}{min}.
\end{equation}

\subsection{Метод CCM}
Зададим траекторную матрицу временного ряда $\bx = [x_1, \ldots, x_n]$ следующим образом: 

\begin{equation*} \label{eq:traj_mat}
	\bH_{\bx} = \begin{bmatrix}
		x_1 & x_2 & \ldots & x_{\tau} \\
		x_2 & x_3 & \ldots & x_{\tau+1} \\
		\vdots & \vdots & \ddots & \vdots \\
		x_{N} & x_{N+1} & \ldots & x_n
	\end{bmatrix}, 
\end{equation*} 

где $N$ --- число задержек, $\tau = n - N + 1$.

Обозначим $i\text{-ый}$ столбец матрицы $\bH_{\bx}$ как $\bx_i$. 
Матрица $\bH_{\bx}$ имеет вид:

\begin{equation*} \label{eq:traj_mat_short}
	\bH_{\bx} = [\bx_1, \ldots, \bx_{\tau}], \qquad \bx_i = [x_i, x_{i+1}, \ldots, x_{i+N-1}]\T 
\end{equation*}

Заметим, что все векторы $\bx_t$ принадлежат $N\text{-мерному}$ траекторному пространству $\dH_{\bx} \subseteq \dR^N$ ряда $\bx$ и образуют фазовую траекторию $\bx(t) \in \dR^N$.

Обнаружение зависимости между рядами $\bx$ и $\bz$ осуществляется следующим образом. Возьмём элемент $\bx_0$ из траекторного пространства $\dH_{\bx}$ и найдём $k$ ближайших соседей в этом же пространстве. Обозначим их временные индексы (от ближнего к дальнему) как $t_1, \ldots, t_k$.

Так как оба ряда определены на одной временной оси, то по значению ряда $\bx$ в момент времени $t_0 \in \{ 1, \ldots, n\}$ можно однозначно получить значение ряда $\bz$ в тот же момент времени, и наоборот. Введём отображение из $\dH_{\bx}$ в $\dH_{\bz}$ следующим образом: 
$$ \phi: \bx_0 \mapsto \widehat{\bz_0} = \sum\limits_{i=1}^k w_i \bz_{t_i}, \qquad 
w_i = \dfrac{u_i}{\sum\limits_{j=1}^k u_j}, \qquad
u_i = \exp(-||\bx_0 - \bx_{t_i}||)$$.

Утверждается, что ряды $\bx$ и $\bz$ связаны, если отображение $\phi$ является липшицевым.
$$ \rho_{\dH_{\bz}}(\phi(\bx_i), \phi(\bx_j)) \leq C \rho_{\dH_{\bx}}(\bx_i, \bx_j) \qquad \bx_i, \bx_j \in \dH_{\bx}. $$

Проверим наличие этого отображения следующим образом. Введём меру близости векторов в окрестностях $U_k(\bx_{t_0})$ и $U_k(\bz_{t_0})$:

\begin{equation}
	L(\bx, \bz) = \dfrac{R(U_k(\bx_{t_0}))}{R(U_k(\bz_{t_0}))}, \qquad R(U_k(\bx_{t_0})) = \dfrac{1}{k} \sum\limits_{i=1}^k \rho_{\dH_{\bx}}(\bx_{t_0}, \bx_{t_j})
\end{equation}

Если $L(x, z)$ больше некоторого порога $C(n)$, то ряд $\bz$ зависит от ряда $\bx$

% Предполагается, что размерность траекторного пространства избыточна, что приводит к неустойчивости прогностической моделей ряда $\bx$.
% Поэтому предлагается рассматривать не саму траекторию $\bx(t)$, а ее проекцию $$\bx_l(t) \in \dR^l, \; l < N$$ в траекторное подпространство 

\subsection{Метод PLS}
Метод частичных наименьших квадратов восстанавливает связь между наборами данных $\bX$ и $\bY$. 
Матрицы объектов $\bX$ и целевая матрица $\bY$ проецируются на латентное пространство $\dR^l$ меньшей размерности следующим образом:
$$ \underset{n \times m}{\bX} = \underset{n \times l}{\bT} \cdot \underset{l \times m}{\bP\T} + \underset{n \times m}{\bE} $$
$$ \underset{n \times k}{\bY} = \underset{n \times l}{\bU} \cdot \underset{l \times k}{\bQ\T} + \underset{n \times k}{\bF}, $$
где $\bT$ и $\bU$ --- матрицы описания объектов и исходов в латентном пространстве, $\bP$ и $\bQ$ --- матрицы перехода из латентного пространства в исходное, $\bE$ и $\bF$ --- матрицы остатков.

Функция преобразования исходных данных имеет вид: 
$$ f(\bX) = \bX\bW_{\bx} \qquad g(\bY) = \bY\bW_{\by}, $$ 
где матрицы весов $\bW_{\bx} \in \dR^{m \times l}$ и $\bW_{\by} \in \dR^{k \times l}$ находятся путём максимизации выборочной ковариации:
$$ (\bW_{\bx}, \bW_{\by}) = \underset{\bW_{\bx}, \bW_{\by}}{argmax}\; \text{Cov}(\bX\bW_{\bx}, \bY\bW_{\by})$$

\subsection{Метод CCA}
Канонический корреляционный анализ находит две матрицы перехода в латентные пространства для $\bX$ и $\bY$ соответственно, так чтобы коэффициент корреляции между проекциями был максимальным.
\begin{equation} \label{eq:cca_optim}
	(\bw_{\bx_1}, \bw_{\by_1}) = \underset{\bw_{\bx}, \bw_{\by}}{argmax}\; \text{Corr}(\bX\bw_{\bx}, \bY\bw_{\by})
\end{equation}
Первые столбцы матриц весов находятся путём решения данной задачи оптимизации \eqref{eq:cca_optim}. 
Затем ищутся векторы, максимизирующие ту же корреляцию, но с ограничением, что они не коррелируют с первой парой векторов.
Процедура продолжается $l$ шагов, где $l$ --- размерность латентного пространства.

\subsection{Алгоритм предсказания}
Пусть дана обучающая выборка $$\mathfrak{D} = \{ (\bx_i, y_i) \: | \: i = 1, \ldots, d \} = (\bX, \by),$$ где $\bx_i$ ~--- элемент траекторного пространства, а $y_i$ ~--- будущее значение временного ряда.
В одномерном случае: $$\bx_i = [x_i, x_{i+1}, \ldots, x_{i+N-1}]\T, \quad y_i = x_{i+N}.$$
Для многомерного ряда его предсказанием служит $k\text{-ая}$ компонента, а в качестве $\bx_i$ выступает его значение в момент времени $i$. Поэтому алгоритм придётся запускать $D$ раз, где $D$ ~--- размерность ряда.

Пусть алгоритм предсказывает значение ряда в момент времени $t_0$. 
Вначале каждому $\bx_i \in X \ \{ x_{t_0}\}$ поставим в соответствие: $$\bw_i = \exp \left(-\dfrac{\theta \cdot ||\bx_i - \bx_{t_0}||}{\frac{1}{d-1} \sum\limits_{j=1, j \neq t_0}^d ||\bx_j - \bx_{t_0}||} \right), $$ 
где $\theta$ ~--- коэффициент локализации.
Таким образом, близкие к $\bx_{t_0}$ соседи имеют больший вес, чем дальние. Затем элементы $\bx_i$ и $y_i$ умножаются на вычисленные веса $\bw_i$

Для прогнозирования ряда используется авторегрессионная модель порядка $t_0-1$:
$$ X_{t_0} = \mu + \psi_1 X_{t_0-1} + \ldots + \psi_{t_0-1} X_1 + u_{t_0}, \qquad u_t \sim WN(0, \sigma^2), \quad \psi_p \neq 0.$$
Обозначим полученный прогноз $\widehat{X_{t_0}}$.
Оптимальность прогноза будем понимать в смысле среднего квадратичного отклонения:
$$ \underset{\psi_1, \ldots, \psi_{t_0-1}}{min} E(\widehat{X_{t_0}} - y_0)^2$$

% Объяснение симплекс метода: \href{http://opetchey.github.io/RREEBES/Sugihara_and_May_1990_Nature/Simplex_projection_walkthrough.html#:~:text=From%20the%20supplementary%20information%20of,lagged%20coordinate%20state%20space%20reconstruction)}{тык}

\section{Вычислительный эксперимент}
Целью эксперимента является сравнение различных стратегий уменьшения размерности целевого пространства. Важной его частью является изучение результатов алгоритма прогнозирования временного ряда, применённого к элементам пространства фазовых траекторий и траекторного подпространства меньшей размерности.

\subsection{Описание данных и работы модели}
Первоначальные данные представляют собой набор видеороликов, на которых выполняются различные движения руками (циклические и хаотические), а также показания акселерометра и гироскопа частотой в 100 Герц, закреплённых на одной из рук. 
Далее по видеоряду с помощью фреймворка alphapose [links] получаются координаты конечностей, а именно 68 ключевых точек.
Затем полученные многомерные ряды приводятся к одной временной шкале с помощью дублирования значений менее длинного ряда.

Перед началом эксперимента зафиксируем следующие переменные: $N$ ~--- размерность траекторного пространства, $k$ ~--- число ближайших соседей, рассматриваемых в CCM, $n_{tr}$ ~--- размер обучающей выборки, $E_{vid}$ ~--- число признаков, полученных из видео-ряда, которые будут использованы в алгоритме.
Для каждой пары компонент, взятых из разных временных рядов, применим метод CCM.
В результате получим матрицу корреляций, в которой на $i\text{-ой}$ строке и $j\text{-ом}$ столбце стоит коэффициент корреляции Пирсона между $i\text{-ой}$ компонентной "приборного" временного ряда и $j\text{-ой}$ компонентой ряда, восстановленного по видео. 
После этого для каждого целевого признака выбираем $E_{vid}$ видео-признаков, обладающих максимальной корреляцией в соответствующей строке.
Затем на основе этих признаков обучается алгоритм.

\begin{figure}[bhtp]
	\includegraphics[width=\textwidth]{gyr_x_pred.png}
	\caption{Синим цветом изображены предсказываемые значения целевой переменной, оранжевым ~--- предсказания, основанные на предыдущих значениях искомой величины, зелёным ~--- прогнозы, использующие данные из видео-ряда}
	\label{fig:1}
\end{figure}

График \ref{fig:1} показывает, что использование дополнительных данных, извлечённых из видео, может быть избыточным. 
На нём видно, как целевая переменная безукоризненно прогнозируется без использования информации из видео-ряда. 
Связано это с тем, что описываемая ею зависимость имеет циклический характер, поскольку полученные данные соответствуют циклическому движению руки.

\subsection{Сравнение методов снижения размерности}
Здесь будет таблица со значениями различных функций потерь (MSE, MAE) для различных методов снижения размерности целевого пространства (PLS, CCA, Neural ODE, Deep CCA, CCM). 
Также будут приведены: график с исходными данными (keypoints + accelerometer), график CCM \href{https://sugiharalab.github.io/EDM_Documentation/algorithms_high_level/}{отсюда}, 

\begin{figure}[bhtp]
	\includegraphics[width=\textwidth]{block_scheme.png}
	\caption{Описание}
	\label{fig:2}
\end{figure}

\bibliographystyle{unsrtnat}
\bibliography{Vladimirov2022RestoringHandMovement.bib}

\end{document}